name: .NET CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Repository
    - name: Checkout code
      uses: actions/checkout@v3

    # 2ï¸âƒ£ ØªØ«Ø¨ÙŠØª .NET SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    # 3ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ dependencies
    - name: Restore dependencies
      run: dotnet restore MyApp/MyApp.csproj

    # 4ï¸âƒ£ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    - name: Build
      run: dotnet build MyApp/MyApp.csproj --configuration Release --no-restore

    # 5ï¸âƒ£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    - name: Run tests
      run: dotnet test MyApp/MyApp.csproj --no-restore --verbosity normal

    # 6ï¸âƒ£ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù†Ø´Ø±
    - name: Publish
      run: dotnet publish MyApp/MyApp.csproj -c Release -o ./publish

    # 7ï¸âƒ£ Ø±ÙØ¹ Ø§Ù„Ù€ artifacts Ù„Ùˆ Ø£Ø­Ø¨Ø¨Øª ØªØ®Ø²ÙŠÙ† Ù†Ø³Ø®Ø©
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: dotnet-app
        path: ./publish

    # 8ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù€ Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 9ï¸âƒ£ Ø¨Ù†Ø§Ø¡ Docker image
    - name: Build Docker image
      run: docker build -f Dockerfile -t ${{ secrets.DOCKER_USERNAME }}/mydotnetapp:latest MyApp

    # ğŸ”Ÿ Ø±ÙØ¹ Ø§Ù„Ù€ Docker image
    - name: Push Docker image
      run: docker push ${{ secrets.DOCKER_USERNAME }}/mydotnetapp:latest
